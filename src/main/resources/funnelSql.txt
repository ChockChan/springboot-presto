select count(distinct user_id), carrier from cdm_event_txt where evt = 'collect' and dt between '2017-03-01' and '2017-08-01' group by carrier
select count(distinct b.user_id), b.carrier from ((select distinct user_id, dt from cdm_event_txt where evt='collect' and dt between '2017-03-01' and '2017-08-01') as a join (select distinct user_id, dt, carrier from cdm_event_txt where evt='addToShoppingcart' and dt between '2017-03-01' and '2017-08-01') as b on a.user_id = b.user_id) where  a.dt < b.dt and date_diff('day', date_parse(b.dt, '%Y-%m-%d'), date_parse(a.dt, '%Y-%m-%d')) < 30 group by b.carrier
select count(distinct d.user_id), d.carrier from (select b.user_id as user_id, b.dt as dt from (select user_id,dt from cdm_event_txt where evt = 'collect' and dt between '2017-03-01' and '2017-08-01') AS a join (select user_id,dt from cdm_event_txt where evt = 'addToShoppingcart' and dt between '2017-03-01' and '2017-08-01') AS b on a.user_id = b.user_id and date_diff('day', date(b.dt), date(a.dt)) < 30 and b.dt > a.dt) as c join (select user_id,dt,carrier from cdm_event_txt where evt = 'submitOrder' and dt between '2017-03-01' and '2017-08-01') AS d on d.user_id = c.user_id where  date_diff('day', date(d.dt), date(c.dt)) < 30 and d.dt > c.dt group by d.carrier
select count(distinct f.user_id), f.carrier from (select d.user_id, d.dt from (select b.user_id as user_id, b.dt as dt from (select user_id,dt from cdm_event_txt where  evt = 'collect' and dt between '2017-03-01' and '2017-08-01' )  AS a  join (select user_id,dt from cdm_event_txt where evt = 'addToShoppingcart' and dt between '2017-03-01' and '2017-08-01') AS b on a.user_id = b.user_id and date_diff('day', date(b.dt), date(a.dt)) < 30 and b.dt > a.dt) as c join (select user_id,dt from cdm_event_txt where evt = 'submitOrder' and dt between '2017-03-01' and '2017-08-01') AS d on d.user_id = c.user_id where  date_diff('day', date(d.dt), date(c.dt)) < 30 and d.dt > c.dt ) as e join (select user_id,dt,carrier from cdm_event_txt where evt = 'deal' and dt between '2017-03-01' and '2017-08-01') AS f on e.user_id = f.user_id where date_diff('day', date(e.dt), date(f.dt)) < 30 and e.dt > f.dt group by f.carrier